<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculadora de Riesgo</title>

<style>
:root{
  --brand:#445DB1;
  --brand-dark:#344A96;
  --brand-soft:rgba(68,93,177,.10);
  --brand-bg:#f3f6fb;

  --good:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
  --crit:#7c3aed;

  --border:rgba(0,0,0,.08);
}

body{
  margin:0;
  background:var(--brand-bg);
  font-family:Segoe UI, Arial;
  padding:20px;
}

.wrap{max-width:1300px;margin:auto;}

header{
  background:linear-gradient(90deg,var(--brand),var(--brand-dark));
  color:white;
  padding:16px;
  border-radius:16px;
  margin-bottom:16px;
}

h1{margin:0;}
.sub{font-size:13px;opacity:.9;}

.card{
  background:white;
  border-radius:16px;
  padding:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  border-top:4px solid var(--brand);
}

.grid{
  display:grid;
  grid-template-columns:1.1fr .9fr;
  gap:16px;
}

.layout-bottom{
  display:grid;
  grid-template-columns:1.1fr .9fr;
  gap:16px;
  margin-top:16px;
}

@media(max-width:1000px){
  .grid,.layout-bottom{grid-template-columns:1fr;}
}

label{font-size:12px;font-weight:600;}
input,select,textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-top:4px;
}
textarea{min-height:70px;}

button{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:700;
}

button.primary{
  background:linear-gradient(90deg,var(--brand),var(--brand-dark));
  color:white;
}

button.muted{background:#eef2ff;}
button.danger{background:#fee2e2;}

.btns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;}

.kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}

.box{
  background:var(--brand-soft);
  padding:12px;
  border-radius:12px;
}

.bar{
  height:12px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
}
.bar div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--brand),var(--brand-dark));
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th{
  background:var(--brand-soft);
  padding:8px;
  text-align:left;
}
td{
  padding:8px;
  border-bottom:1px solid var(--border);
}

canvas{width:100%;height:260px;}
</style>
</head>

<body>
<div class="wrap">

<header>
<h1>Calculadora de Riesgo</h1>
<div class="sub">
Base = P×I · Ajustado = Base×(1+CIA%)×Activo · Residual = Ajustado×Controles
</div>
</header>

<div class="grid">

<div class="card">
<label>ID del riesgo *</label>
<input id="risk_id">

<label style="margin-top:10px;">Descripción</label>
<textarea id="desc"></textarea>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
<div>
<label>Probabilidad</label>
<select id="prob"></select>
</div>
<div>
<label>Impacto</label>
<select id="impacto"></select>
</div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;">
<div>
<label>Confidencialidad</label>
<select id="cia_conf"></select>
</div>
<div>
<label>Integridad</label>
<select id="cia_int"></select>
</div>
<div>
<label>Disponibilidad</label>
<select id="cia_disp"></select>
</div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
<div>
<label>Valor Activo</label>
<select id="valor_activo"></select>
</div>
<div>
<label>Controles existentes</label>
<select id="controles"></select>
</div>
</div>

<div class="btns">
<button class="primary" onclick="calcular()">Calcular</button>
<button class="primary" onclick="agregar()">Agregar al concentrado</button>
<button class="muted" onclick="limpiar()">Limpiar</button>
</div>
</div>

<div class="card">
<h3>Resultados</h3>

<div class="kpi">
<div class="box">
Base: <b id="base">—</b>
</div>
<div class="box">
Residual: <b id="residual">—</b>
</div>
</div>

<div style="margin-top:10px;">
<div style="display:flex;justify-content:space-between;font-size:12px;">
<span>Nivel</span><span id="nivel">—</span>
</div>
<div class="bar"><div id="fill"></div></div>
</div>

</div>

</div>

<div class="layout-bottom">

<div class="card">
<h3>Concentrado</h3>
<div class="btns">
<button onclick="exportarCSV()">Exportar CSV</button>
<button onclick="exportarExcel()">Exportar Excel</button>
<button class="danger" onclick="limpiarConcentrado()">Limpiar</button>
</div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Residual</th>
<th>Nivel</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<div class="card">
<h3>Gráfica</h3>
<canvas id="chart"></canvas>
</div>

</div>

</div>

<script>
// =====================
// CONFIGURACIÓN
// =====================
const PROB = [1,2,3,4,5];
const CIA = {Ninguno:0, Bajo:.1, Medio:.2, Alto:.3};
const ACTIVO = {Bajo:1, Medio:1.2, Alto:1.3, Critico:1.5};
const CONTROLES = {Ninguno:1, Parcial:.8, Moderado:.6, Fuerte:.4};

let concentrado = [];

function fillSelect(id, arr){
  const sel = document.getElementById(id);
  sel.innerHTML="";
  arr.forEach(v=>{
    const op=document.createElement("option");
    op.value=v;
    op.textContent=v;
    sel.appendChild(op);
  });
}

function fillSelectObj(id,obj){
  const sel=document.getElementById(id);
  sel.innerHTML="";
  Object.keys(obj).forEach(k=>{
    const op=document.createElement("option");
    op.value=k;
    op.textContent=k;
    sel.appendChild(op);
  });
}

fillSelect("prob",PROB);
fillSelect("impacto",PROB);
fillSelectObj("cia_conf",CIA);
fillSelectObj("cia_int",CIA);
fillSelectObj("cia_disp",CIA);
fillSelectObj("valor_activo",ACTIVO);
fillSelectObj("controles",CONTROLES);

function clasificar(v){
  if(v<=10)return "Bajo";
  if(v<=25)return "Medio";
  if(v<=50)return "Alto";
  return "Crítico";
}

function calcular(){
  const p=Number(prob.value);
  const i=Number(impacto.value);
  const base=p*i;

  const ciaPct = CIA[cia_conf.value] + CIA[cia_int.value] + CIA[cia_disp.value];
  const activoMult = ACTIVO[valor_activo.value];
  const ctrlMult = CONTROLES[controles.value];

  const ajustado = base*(1+ciaPct)*activoMult;
  const residual = ajustado*ctrlMult;

  baseEl.textContent=base.toFixed(2);
  residualEl.textContent=residual.toFixed(2);

  const nivel=clasificar(residual);
  nivelEl.textContent=nivel;

  fill.style.width=Math.min(100,(residual/75)*100)+"%";

  ultimo = {
    id:risk_id.value,
    residual:residual,
    nivel:nivel
  };
}

const baseEl=document.getElementById("base");
const residualEl=document.getElementById("residual");
const nivelEl=document.getElementById("nivel");
const fill=document.getElementById("fill");

let ultimo=null;

function agregar(){
  if(!ultimo)return alert("Calcula primero");
  concentrado.push(ultimo);
  render();
}

function render(){
  const tb=document.getElementById("tabla");
  tb.innerHTML="";
  concentrado.forEach(r=>{
    tb.innerHTML+=`<tr><td>${r.id}</td><td>${r.residual.toFixed(2)}</td><td>${r.nivel}</td></tr>`;
  });
  renderGrafica();
}

function limpiar(){
  risk_id.value="";
  desc.value="";
}

function limpiarConcentrado(){
  concentrado=[];
  render();
}

function exportarCSV(){
  if(concentrado.length===0)return;
  let csv="ID,Residual,Nivel\n";
  concentrado.forEach(r=>{
    csv+=`${r.id},${r.residual},${r.nivel}\n`;
  });
  const blob=new Blob([csv]);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="riesgos.csv";
  a.click();
}

function exportarExcel(){
  if(concentrado.length===0)return;
  let html="<table><tr><th>ID</th><th>Residual</th><th>Nivel</th></tr>";
  concentrado.forEach(r=>{
    html+=`<tr><td>${r.id}</td><td>${r.residual}</td><td>${r.nivel}</td></tr>`;
  });
  html+="</table>";
  const blob=new Blob([html],{type:"application/vnd.ms-excel"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="riesgos.xls";
  a.click();
}

function renderGrafica(){
  const ctx=chart.getContext("2d");
  ctx.clearRect(0,0,chart.width,chart.height);

  const counts={Bajo:0,Medio:0,Alto:0,Crítico:0};
  concentrado.forEach(r=>counts[r.nivel]++);

  const labels=["Bajo","Medio","Alto","Crítico"];
  const colors=["#16a34a","#f59e0b","#dc2626","#7c3aed"];

  const max=Math.max(...Object.values(counts),1);
  const barW=60;
  labels.forEach((l,i)=>{
    const val=counts[l];
    const h=(val/max)*200;
    ctx.fillStyle=colors[i];
    ctx.fillRect(50+i*100,250-h,barW,h);
    ctx.fillStyle="#000";
    ctx.fillText(l,50+i*100,270);
    ctx.fillText(val,50+i*100,240-h);
  });
}
</script>

</body>
</html>
