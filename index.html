<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Riesgo</title>

  <style>
    :root{
      /* Paleta inspirada en CONTPAQi */
      --brand:#005EB8;
      --brand-dark:#004A92;
      --ink:#263031;
      --muted:#7C878E;

      /* UI */
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#263031;
      --border:rgba(0,0,0,.10);

      /* Estados */
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --crit:#7c3aed;
    }

    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{margin:0; min-height:100vh; color:var(--text); background:var(--bg); padding:20px;}
    .wrap{max-width:1280px; margin:0 auto;}

    header{margin-bottom:12px;}
    h1{margin:0; font-size:28px; color:var(--brand); letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(0,94,184,.25);
      border-radius:999px;
      padding:8px 12px;
      background: rgba(0,94,184,.06);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:#94a3b8;}
    .pill strong{font-size:13px;}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }

    .top-form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }

    .section-title{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
      margin-bottom:10px;
    }
    .section-title h2{margin:0; font-size:16px; color:var(--ink);}
    .hint{color:var(--muted); font-size:12px; line-height:1.35;}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:12px;}
    label{display:block; color:var(--ink); font-size:12px; margin-bottom:6px;}

    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:88px; resize:vertical;}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(0,94,184,.65);
      box-shadow: 0 0 0 3px rgba(0,94,184,.15);
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      cursor:pointer;
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
    }
    button.primary{
      background: linear-gradient(90deg, rgba(0,94,184,.20), rgba(0,94,184,.08));
      border-color: rgba(0,94,184,.35);
    }
    button.primary:hover{
      background: linear-gradient(90deg, rgba(0,94,184,.30), rgba(0,94,184,.12));
      border-color: rgba(0,94,184,.45);
    }
    button.muted{background:#f3f4f6;}
    button.danger{border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.06);}

    .divider{height:1px; background:rgba(0,0,0,.08); margin:14px 0;}
    .small{font-size:12px; color:var(--muted); line-height:1.35;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .box .t{color:var(--muted); font-size:12px;}
    .box .v{margin-top:4px; font-size:22px; font-weight:900; color:var(--ink);}
    .box .s{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35;}

    .bar{height:12px; border-radius:999px; background:rgba(0,0,0,.08); overflow:hidden; border:1px solid var(--border);}
    .bar > div{height:100%; width:0%; background:var(--brand);}

    ul{margin:8px 0 0 18px; padding:0;}
    li{color:var(--muted); margin:6px 0; font-size:12px; line-height:1.35;}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--border); border-radius:12px; background:#fff;}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(0,0,0,.06); font-size:12px; vertical-align:top;}
    th{background:rgba(0,94,184,.06); text-align:left; color:var(--ink); font-size:12px;}
    tr:last-child td{border-bottom:none;}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      font-size:11px; white-space:nowrap;
    }

    .layout-bottom{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }

    canvas{width:100%; height:260px; display:block;}
    .chartWrap{padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff;}
    .chartLegend{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;}
    .legendItem{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);}
    .swatch{width:10px; height:10px; border-radius:3px;}

    /* ISO seleccionados “chips” */
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      color:var(--ink);
    }
    .chip .x{
      width:18px; height:18px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(0,0,0,.12);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    @media (max-width: 1020px){
      .top-form{grid-template-columns: 1fr;}
      .grid{grid-template-columns:1fr;}
      .layout-bottom{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Calculadora de Riesgo</h1>
      <div class="sub">
        Modelo: <span class="mono">Base = P×I</span> ·
        <span class="mono">Ajustado = Base×(1+CIA%)×Activo</span> ·
        <span class="mono">Residual = Ajustado×FactorControles</span>
      </div>
    </header>

    <!-- ID y descripción arriba -->
    <div class="card" style="margin-bottom:12px;">
      <div class="section-title">
        <h2>Identificación del riesgo</h2>
        <div class="hint">ID obligatorio. Descripción opcional.</div>
      </div>

      <div class="top-form">
        <div>
          <label>ID del riesgo *</label>
          <input id="risk_id" placeholder="Ej. R-2026-001" />
          <div class="small">Usa un folio único.</div>
        </div>
        <div>
          <label>Área / Proceso (opcional)</label>
          <input id="area" placeholder="Ej. TI / Desarrollo" />
        </div>
      </div>

      <div>
        <label>Descripción del riesgo (opcional)</label>
        <textarea id="desc" placeholder="Ej. Acceso no autorizado por falta de MFA..."></textarea>
      </div>
    </div>

    <div class="grid">
      <!-- Entradas -->
      <div class="card">
        <div class="section-title">
          <h2>Entradas</h2>
          <div class="hint">Selecciona criterios y presiona <b>Calcular</b>.</div>
        </div>

        <div class="row">
          <div>
            <label>Probabilidad</label>
            <select id="prob"></select>
            <div class="small" id="prob_det"></div>
          </div>
          <div>
            <label>Impacto</label>
            <select id="impacto"></select>
            <div class="small" id="impacto_det"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Modificador CIA</h2>
          <div class="hint">Suma porcentajes. Ejemplo: Alto+Alto+Alto = <b>+90%</b>.</div>
        </div>

        <div class="row3">
          <div>
            <label>Confidencialidad</label>
            <select id="cia_conf"></select>
          </div>
          <div>
            <label>Integridad</label>
            <select id="cia_int"></select>
          </div>
          <div>
            <label>Disponibilidad</label>
            <select id="cia_disp"></select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Valor del activo</label>
            <select id="valor_activo"></select>
            <div class="small">Aumenta el riesgo según criticidad del activo.</div>
          </div>
          <div>
            <label>Controles existentes</label>
            <select id="controles"></select>
            <div class="small">Reduce el riesgo según madurez/fortaleza de controles.</div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- ISO: lista + agregar + manual -->
        <div class="section-title">
          <h2>Controles ISO/IEC 27001:2022</h2>
          <div class="hint">Elige de la lista o agrega uno manual.</div>
        </div>

        <div class="row">
          <div>
            <label>Buscar control</label>
            <input id="iso_search" placeholder="Ej. 8.8 o 'vulnerabilidad'..." />
            <div class="small">Tip: escribe “5.”, “6.”, “7.” u “8.” para filtrar por sección.</div>

            <div style="margin-top:10px;">
              <label>Lista de controles</label>
              <select id="iso_catalogo" size="9"></select>
              <div class="btns" style="margin-top:10px;">
                <button class="primary" type="button" onclick="agregarControlDesdeLista()">Agregar control</button>
              </div>
            </div>
          </div>

          <div>
            <label>Agregar control manual (opcional)</label>
            <input id="iso_manual" placeholder="Ej. 8.28 — Codificación segura / 5.15 — Control de acceso" />
            <div class="btns" style="margin-top:10px;">
              <button type="button" onclick="agregarControlManual()">Agregar manual</button>
              <button class="muted" type="button" onclick="limpiarControlesISO()">Limpiar seleccionados</button>
            </div>

            <div class="box" style="margin-top:10px;">
              <div class="t">Controles seleccionados</div>
              <div class="small">Da clic en “×” para quitar un control.</div>
              <div class="chips" id="iso_chips"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="btns">
          <button class="primary" type="button" onclick="calcular()">Calcular</button>
          <button class="primary" type="button" onclick="agregarAlConcentrado()">Agregar al concentrado</button>
          <button class="muted" type="button" onclick="limpiarFormulario()">Limpiar formulario</button>
        </div>
      </div>

      <!-- Resultados -->
      <div class="card">
        <div class="section-title">
          <h2>Resultados</h2>
          <div class="hint">Resultados numéricos + clasificación.</div>
        </div>

        <!-- Estatus ahora aquí adentro -->
        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
          <div class="pill">
            <span class="dot" id="dot"></span>
            <strong id="estado">Sin calcular</strong>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="t">Riesgo base (P×I)</div>
            <div class="v" id="score_base">—</div>
            <div class="s">Rango: 1 a 25</div>
          </div>
          <div class="box">
            <div class="t">Riesgo ajustado</div>
            <div class="v" id="score_ajustado">—</div>
            <div class="s">Incluye CIA y activo</div>
          </div>
        </div>

        <div class="box" style="margin-top:10px;">
          <div class="t">Modificadores</div>
          <div class="s">
            CIA: <b id="mod_cia">—</b> &nbsp;|&nbsp;
            Activo: <b id="mod_activo">—</b> &nbsp;|&nbsp;
            Controles: <b id="mod_controles">—</b>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box">
            <div class="t">Riesgo residual</div>
            <div class="v" id="score_residual">—</div>
            <div class="s" id="nivel">Clasificación: —</div>
          </div>
          <div class="box">
            <div class="t">Acción prioritaria</div>
            <div class="v" style="font-size:14px; font-weight:900;" id="accion_prior">—</div>
            <div class="s">Definida con base en residual</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="small" style="display:flex;justify-content:space-between;margin-bottom:6px;">
            <span>Indicador visual</span>
            <span id="pct">0%</span>
          </div>
          <div class="bar"><div id="fill"></div></div>
          <div class="hint" id="out_detalle" style="margin-top:10px;">—</div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Recomendaciones</h2>
          <div class="hint">Sugerencias generales.</div>
        </div>
        <ul id="recs"></ul>
      </div>
    </div>

    <!-- Abajo: concentrado + export + gráficas -->
    <div class="layout-bottom">
      <div class="card">
        <div class="section-title">
          <h2>Concentrado de riesgos</h2>
          <div class="hint">Se llena con “Agregar al concentrado”.</div>
        </div>

        <div class="btns" style="margin-bottom:10px;">
          <button class="muted" type="button" onclick="exportarCSV()">Exportar CSV</button>
          <button class="muted" type="button" onclick="exportarExcelXLS()">Exportar Excel (.xls)</button>
          <button class="danger" type="button" onclick="limpiarConcentrado()">Limpiar concentrado</button>
        </div>

        <div style="overflow:auto;">
          <table id="tabla_concentrado">
            <thead>
              <tr>
                <th>ID</th>
                <th>Área</th>
                <th>Descripción</th>
                <th>Prob</th>
                <th>Impacto</th>
                <th>Residual</th>
                <th>Nivel</th>
                <th>Acción</th>
                <th>ISO</th>
              </tr>
            </thead>
            <tbody id="tbl_body">
              <tr><td colspan="9" class="small">Aún no has agregado riesgos al concentrado.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h2>Gráficas</h2>
          <div class="hint">Nivel del concentrado + mapa de calor 5×5 (evaluación).</div>
        </div>

        <div class="chartWrap" style="margin-bottom:12px;">
          <div class="small" style="margin-bottom:6px;"><b>1) Conteo por nivel (concentrado)</b></div>
          <canvas id="chartNiveles" width="700" height="260"></canvas>
          <div class="chartLegend">
            <div class="legendItem"><span class="swatch" style="background:var(--good)"></span> Bajo</div>
            <div class="legendItem"><span class="swatch" style="background:var(--warn)"></span> Medio</div>
            <div class="legendItem"><span class="swatch" style="background:var(--bad)"></span> Alto</div>
            <div class="legendItem"><span class="swatch" style="background:var(--crit)"></span> Crítico</div>
          </div>
          <div class="small" style="margin-top:8px;" id="statsNiveles">—</div>
        </div>

        <div class="chartWrap">
          <div class="small" style="margin-bottom:6px;"><b>2) Mapa de calor 5×5 (Probabilidad × Impacto)</b></div>
          <canvas id="chartHeatmap" width="700" height="320"></canvas>
          <div class="small" style="margin-top:8px;">
            Marca: <b>riesgo actual</b> (último calculado).
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // Criterios (ES)
    // =========================
    const PROBABILIDAD = [
      { n: 1, label: "1 - Raro (<1% anual)", detalle: "Muy poco probable. Frecuencia esperada: >5 años." },
      { n: 2, label: "2 - Improbable (1–10% anual)", detalle: "Poco probable. Frecuencia esperada: 2–5 años." },
      { n: 3, label: "3 - Posible (10–50% anual)", detalle: "Podría ocurrir. Frecuencia esperada: 1–5 años." },
      { n: 4, label: "4 - Probable (50–90% anual)", detalle: "Probable. Frecuencia esperada: 6–12 meses." },
      { n: 5, label: "5 - Casi seguro (>90% anual)", detalle: "Altamente probable. Frecuencia esperada: <6 meses." },
    ];

    const IMPACTO = [
      { n: 1, label: "1 - Insignificante (<$10K pérdida)", detalle: "Impacto menor. Manejo local." },
      { n: 2, label: "2 - Menor ($10K–$100K pérdida)", detalle: "Impacto bajo/moderado." },
      { n: 3, label: "3 - Moderado ($100K–$1M pérdida)", detalle: "Impacto significativo. Requiere gestión." },
      { n: 4, label: "4 - Mayor ($1M–$10M pérdida)", detalle: "Impacto alto. Afecta objetivos críticos." },
      { n: 5, label: "5 - Catastrófico (>$10M pérdida)", detalle: "Impacto extremo. Afecta continuidad." },
    ];

    // Ninguno=0%, Bajo=10%, Medio=20%, Alto=30%
    const CIA = [
      { key: "Ninguno", label: "Ninguno", pct: 0.00 },
      { key: "Bajo",    label: "Bajo",    pct: 0.10 },
      { key: "Medio",   label: "Medio",   pct: 0.20 },
      { key: "Alto",    label: "Alto",    pct: 0.30 },
    ];

    const VALOR_ACTIVO = [
      { key: "No especificado", label: "No especificado", mult: 1.0 },
      { key: "Valor Bajo", label: "Valor Bajo", mult: 1.0 },
      { key: "Valor Medio", label: "Valor Medio", mult: 1.2 },
      { key: "Valor Alto", label: "Valor Alto", mult: 1.3 },
      { key: "Crítico/Esencial para la Misión", label: "Crítico/Esencial para la Misión", mult: 1.5 },
    ];

    const CONTROLES_EXISTENTES = [
      { key: "No Especificado", label: "No especificado", factor: 1.0 },
      { key: "Ninguno Implementado", label: "Ninguno implementado", factor: 1.0 },
      { key: "Débil/Parcial", label: "Débil / Parcial", factor: 0.8 },
      { key: "Moderado", label: "Moderado", factor: 0.6 },
      { key: "Fuerte/Integral", label: "Fuerte / Integral", factor: 0.4 },
    ];

    // ISO catálogo completo ISO/IEC 27001:2022 (93 controles)
    const ISO_CATALOGO = [
      // 5 Organizacionales
      { id:"5.1",  nombre:"Políticas de seguridad de la información" },
      { id:"5.2",  nombre:"Funciones y responsabilidades de seguridad de la información" },
      { id:"5.3",  nombre:"Separación de funciones" },
      { id:"5.4",  nombre:"Responsabilidades de gestión" },
      { id:"5.5",  nombre:"Contacto con las autoridades" },
      { id:"5.6",  nombre:"Contacto con grupos de interés especial" },
      { id:"5.7",  nombre:"Inteligencia de amenazas" },
      { id:"5.8",  nombre:"Seguridad de la información en la gestión de proyectos" },
      { id:"5.9",  nombre:"Inventario de información y otros activos asociados" },
      { id:"5.10", nombre:"Uso aceptable de la información y otros activos asociados" },
      { id:"5.11", nombre:"Devolución de activos" },
      { id:"5.12", nombre:"Clasificación de la información" },
      { id:"5.13", nombre:"Etiquetado de la información" },
      { id:"5.14", nombre:"Transferencia de información" },
      { id:"5.15", nombre:"Control de acceso" },
      { id:"5.16", nombre:"Gestión de identidades" },
      { id:"5.17", nombre:"Información de autenticación" },
      { id:"5.18", nombre:"Derechos de acceso" },
      { id:"5.19", nombre:"Seguridad de la información en las relaciones con los proveedores" },
      { id:"5.20", nombre:"Abordar la seguridad de la información dentro de los acuerdos con proveedores" },
      { id:"5.21", nombre:"Gestión de la seguridad de la información en la cadena de suministro de las TIC" },
      { id:"5.22", nombre:"Seguimiento, revisión y gestión del cambio de los servicios de los proveedores" },
      { id:"5.23", nombre:"Seguridad de la información para el uso de servicios en la nube" },
      { id:"5.24", nombre:"Planificación y preparación de la gestión de incidentes de seguridad de la información" },
      { id:"5.25", nombre:"Evaluación y decisión sobre eventos de seguridad de la información" },
      { id:"5.26", nombre:"Respuesta a incidentes de seguridad de la información" },
      { id:"5.27", nombre:"Aprender de los incidentes de seguridad de la información" },
      { id:"5.28", nombre:"Recopilación de pruebas" },
      { id:"5.29", nombre:"Seguridad de la información durante interrupciones" },
      { id:"5.30", nombre:"Preparación de las TIC para la continuidad de las actividades" },
      { id:"5.31", nombre:"Requisitos legales, legales, reglamentarios y contractuales" },
      { id:"5.32", nombre:"Derechos de propiedad intelectual" },
      { id:"5.33", nombre:"Protección de registros" },
      { id:"5.34", nombre:"Privacidad y protección de la PII" },
      { id:"5.35", nombre:"Revisión independiente de la seguridad de la información" },
      { id:"5.36", nombre:"Cumplimiento de políticas, reglas y estándares de seguridad de la información" },
      { id:"5.37", nombre:"Procedimientos operativos documentados" },

      // 6 Personas
      { id:"6.1", nombre:"Investigación" },
      { id:"6.2", nombre:"Términos y condiciones de empleo" },
      { id:"6.3", nombre:"Sensibilización, educación y formación en materia de seguridad de la información" },
      { id:"6.4", nombre:"Proceso disciplinario" },
      { id:"6.5", nombre:"Responsabilidades después de la terminación o cambio de empleo" },
      { id:"6.6", nombre:"Acuerdos de confidencialidad o no divulgación" },
      { id:"6.7", nombre:"Trabajo remoto" },
      { id:"6.8", nombre:"Informe de eventos de seguridad de la información" },

      // 7 Físicos
      { id:"7.1",  nombre:"Perímetros de seguridad física" },
      { id:"7.2",  nombre:"Entrada física" },
      { id:"7.3",  nombre:"Asegurar oficinas, habitaciones e instalaciones" },
      { id:"7.4",  nombre:"Supervisión de la seguridad física" },
      { id:"7.5",  nombre:"Protección contra amenazas físicas y ambientales" },
      { id:"7.6",  nombre:"Trabajar en áreas seguras" },
      { id:"7.7",  nombre:"Escritorio limpio y pantalla limpia" },
      { id:"7.8",  nombre:"Emplazamiento y protección de equipos" },
      { id:"7.9",  nombre:"Seguridad de los bienes fuera de las instalaciones" },
      { id:"7.10", nombre:"Medios de almacenamiento" },
      { id:"7.11", nombre:"Servicios públicos de apoyo" },
      { id:"7.12", nombre:"Seguridad del cableado" },
      { id:"7.13", nombre:"Mantenimiento de equipos" },
      { id:"7.14", nombre:"Eliminación o reutilización segura del equipo" },

      // 8 Tecnológicos
      { id:"8.1",  nombre:"Dispositivos de punto final de usuario" },
      { id:"8.2",  nombre:"Derechos de acceso privilegiado" },
      { id:"8.3",  nombre:"Restricción de acceso a la información" },
      { id:"8.4",  nombre:"Acceso al código fuente" },
      { id:"8.5",  nombre:"Autenticación segura" },
      { id:"8.6",  nombre:"Gestión de la capacidad" },
      { id:"8.7",  nombre:"Protección contra malware" },
      { id:"8.8",  nombre:"Gestión de vulnerabilidades técnicas" },
      { id:"8.9",  nombre:"Gestión de la configuración" },
      { id:"8.10", nombre:"Eliminación de información" },
      { id:"8.11", nombre:"Enmascaramiento de datos" },
      { id:"8.12", nombre:"Prevención de fuga de datos" },
      { id:"8.13", nombre:"Copia de seguridad de la información" },
      { id:"8.14", nombre:"Redundancia de las instalaciones de procesamiento de información" },
      { id:"8.15", nombre:"Registro" },
      { id:"8.16", nombre:"Actividades de seguimiento" },
      { id:"8.17", nombre:"Sincronización del reloj" },
      { id:"8.18", nombre:"Uso de programas de utilidad privilegiados" },
      { id:"8.19", nombre:"Instalación de software en sistemas operativos" },
      { id:"8.20", nombre:"Seguridad de redes" },
      { id:"8.21", nombre:"Seguridad de los servicios de red" },
      { id:"8.22", nombre:"Segregación de redes" },
      { id:"8.23", nombre:"Filtrado web" },
      { id:"8.24", nombre:"Uso de la criptografía" },
      { id:"8.25", nombre:"Ciclo de vida de desarrollo seguro" },
      { id:"8.26", nombre:"Requisitos de seguridad de las aplicaciones" },
      { id:"8.27", nombre:"Arquitectura de sistemas seguros y principios de ingeniería" },
      { id:"8.28", nombre:"Codificación segura" },
      { id:"8.29", nombre:"Pruebas de seguridad en desarrollo y aceptación" },
      { id:"8.30", nombre:"Desarrollo externalizado" },
      { id:"8.31", nombre:"Separación de entornos de desarrollo, prueba y producción" },
      { id:"8.32", nombre:"Gestión del cambio" },
      { id:"8.33", nombre:"Información de la prueba" },
      { id:"8.34", nombre:"Protección de los sistemas de información durante las pruebas de auditoría" },
    ];

    // =========================
    // Estado
    // =========================
    let ultimoResultado = null;
    let concentrado = [];
    let isoSeleccionados = []; // array de strings

    // =========================
    // Helpers
    // =========================
    function fillSelectByN(selId, arr){
      const sel = document.getElementById(selId);
      sel.innerHTML = "";
      arr.forEach(o=>{
        const op = document.createElement("option");
        op.value = o.n;
        op.textContent = o.label;
        sel.appendChild(op);
      });
      sel.value = arr[2]?.n ?? arr[0]?.n ?? 1;
    }

    function fillSelectByKey(selId, arr, defaultKey){
      const sel = document.getElementById(selId);
      sel.innerHTML = "";
      arr.forEach(o=>{
        const op = document.createElement("option");
        op.value = o.key;
        op.textContent = o.label;
        sel.appendChild(op);
      });
      sel.value = defaultKey ?? arr[0]?.key ?? "";
    }

    function getByN(arr, n){ return arr.find(x => x.n === n); }
    function getByKey(arr, k){ return arr.find(x => x.key === k); }

    function setDotColor(kind){
      const dot = document.getElementById("dot");
      const fill = document.getElementById("fill");
      const styles = getComputedStyle(document.documentElement);

      let color = "#94a3b8";
      if (kind === "good") color = styles.getPropertyValue("--good").trim();
      if (kind === "warn") color = styles.getPropertyValue("--warn").trim();
      if (kind === "bad")  color = styles.getPropertyValue("--bad").trim();
      if (kind === "crit") color = styles.getPropertyValue("--crit").trim();

      dot.style.background = color;
      fill.style.background = color;
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // ISO UI
    // =========================
    function renderCatalogoISO(filtro=""){
      const sel = document.getElementById("iso_catalogo");
      const q = (filtro || "").toLowerCase().trim();
      sel.innerHTML = "";

      ISO_CATALOGO
        .filter(c => !q || c.id.toLowerCase().includes(q) || c.nombre.toLowerCase().includes(q))
        .forEach(c=>{
          const op = document.createElement("option");
          op.value = `${c.id} — ${c.nombre}`;
          op.textContent = `${c.id} — ${c.nombre}`;
          sel.appendChild(op);
        });

      if (sel.options.length === 0){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "Sin resultados";
        sel.appendChild(op);
      }
    }

    function agregarControlDesdeLista(){
      const sel = document.getElementById("iso_catalogo");
      const val = sel.value;
      if (!val) return;
      agregarISO(val);
    }

    function agregarControlManual(){
      const txt = document.getElementById("iso_manual").value.trim();
      if (!txt) return;
      agregarISO(txt);
      document.getElementById("iso_manual").value = "";
    }

    function agregarISO(item){
      const limpio = item.trim();
      if (!limpio) return;
      if (!isoSeleccionados.includes(limpio)){
        isoSeleccionados.push(limpio);
        renderISOChips();
      }
    }

    function quitarISO(item){
      isoSeleccionados = isoSeleccionados.filter(x => x !== item);
      renderISOChips();
    }

    function limpiarControlesISO(){
      isoSeleccionados = [];
      renderISOChips();
    }

    function renderISOChips(){
      const wrap = document.getElementById("iso_chips");
      wrap.innerHTML = "";

      if (isoSeleccionados.length === 0){
        wrap.innerHTML = `<span class="small">—</span>`;
        return;
      }

      isoSeleccionados.forEach(item=>{
        const div = document.createElement("div");
        div.className = "chip";
        div.innerHTML = `<span class="mono">${escapeHtml(item)}</span> <span class="x" title="Quitar">×</span>`;
        div.querySelector(".x").addEventListener("click", ()=>quitarISO(item));
        wrap.appendChild(div);
      });
    }

    // =========================
    // Clasificación y recomendaciones
    // =========================
    function clasificar(scoreResidual){
      if (scoreResidual <= 10) return {
        nivel:"Bajo", accion:"Aceptar / Revisar periódicamente", sem:"good",
        rec:[
          "Aceptar el riesgo y documentarlo en el registro de riesgos.",
          "Definir revisión periódica (por ejemplo, trimestral).",
          "Mantener evidencias mínimas de monitoreo."
        ]
      };
      if (scoreResidual <= 25) return {
        nivel:"Medio", accion:"Monitorear / Revisar", sem:"warn",
        rec:[
          "Documentar el riesgo y asignar responsable.",
          "Definir mejoras rápidas a controles existentes (quick wins).",
          "Monitorear indicadores y revisar en comité o seguimiento mensual."
        ]
      };
      if (scoreResidual <= 50) return {
        nivel:"Alto", accion:"Mitigar (prioritario)", sem:"bad",
        rec:[
          "Definir plan de tratamiento con acciones, responsables y fechas.",
          "Fortalecer controles de acceso (MFA, privilegios mínimos, segregación).",
          "Implementar cifrado y monitoreo (logging, alertas).",
          "Mejorar continuidad (respaldos, pruebas de restauración, DR)."
        ]
      };
      return {
        nivel:"Crítico", accion:"Acción inmediata (escalar)", sem:"crit",
        rec:[
          "Escalar de inmediato a dirección/gerencia y al responsable del SGSI.",
          "Aplicar controles compensatorios urgentes para reducir exposición.",
          "Considerar detener/evitar la actividad hasta tratar el riesgo.",
          "Seguimiento diario hasta estabilizar."
        ]
      };
    }

    // =========================
    // Cálculo
    // =========================
    function calcular(){
      const id = document.getElementById("risk_id").value.trim();
      if (!id){
        alert("Por favor ingresa el ID del riesgo (obligatorio).");
        return;
      }

      const area = document.getElementById("area").value.trim();
      const desc = document.getElementById("desc").value.trim();

      const p = Number(document.getElementById("prob").value);
      const i = Number(document.getElementById("impacto").value);

      const ciaC = getByKey(CIA, document.getElementById("cia_conf").value);
      const ciaI = getByKey(CIA, document.getElementById("cia_int").value);
      const ciaD = getByKey(CIA, document.getElementById("cia_disp").value);

      const activo = getByKey(VALOR_ACTIVO, document.getElementById("valor_activo").value);
      const ctrl = getByKey(CONTROLES_EXISTENTES, document.getElementById("controles").value);

      const base = p * i;
      const ciaPct = (ciaC?.pct || 0) + (ciaI?.pct || 0) + (ciaD?.pct || 0);
      const multActivo = activo?.mult || 1.0;
      const factorCtrl = ctrl?.factor ?? 1.0;

      const ajustado = base * (1 + ciaPct) * multActivo;
      const residual = ajustado * factorCtrl;

      const pObj = getByN(PROBABILIDAD, p);
      const iObj = getByN(IMPACTO, i);
      document.getElementById("prob_det").textContent = pObj?.detalle || "";
      document.getElementById("impacto_det").textContent = iObj?.detalle || "";

      document.getElementById("score_base").textContent = base.toFixed(2);
      document.getElementById("score_ajustado").textContent = ajustado.toFixed(2);
      document.getElementById("score_residual").textContent = residual.toFixed(2);

      document.getElementById("mod_cia").textContent = `+${Math.round(ciaPct*100)}%`;
      document.getElementById("mod_activo").textContent = `${multActivo.toFixed(1)}x`;
      document.getElementById("mod_controles").textContent = `${factorCtrl.toFixed(1)}`;

      const c = clasificar(residual);
      document.getElementById("nivel").textContent = `Clasificación: ${c.nivel}`;
      document.getElementById("accion_prior").textContent = c.accion;
      document.getElementById("estado").textContent = c.accion;
      setDotColor(c.sem);

      const ul = document.getElementById("recs");
      ul.innerHTML = "";
      c.rec.forEach(t=>{
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });

      const max = 75;
      const pct = Math.max(0, Math.min(100, Math.round((residual / max) * 100)));
      document.getElementById("pct").textContent = pct + "%";
      document.getElementById("fill").style.width = pct + "%";

      const isoTxt = isoSeleccionados.join("; ");
      document.getElementById("out_detalle").textContent =
        `ID: ${id} | Área: ${area || "—"} | Base: ${p}×${i}=${base.toFixed(2)} | CIA: +${Math.round(ciaPct*100)}% | Activo: ${multActivo.toFixed(1)}x | Controles: ${factorCtrl.toFixed(1)} | Residual: ${residual.toFixed(2)} | ISO: ${isoTxt || "—"}`;

      ultimoResultado = {
        id, area, desc,
        prob: p, impacto: i,
        base: Number(base.toFixed(2)),
        ajustado: Number(ajustado.toFixed(2)),
        residual: Number(residual.toFixed(2)),
        nivel: c.nivel,
        accion: c.accion,
        iso: [...isoSeleccionados]
      };

      renderHeatmap(ultimoResultado);
    }

    // =========================
    // Concentrado
    // =========================
    function agregarAlConcentrado(){
      if (!ultimoResultado){
        alert("Primero calcula un riesgo (botón Calcular).");
        return;
      }

      const ya = concentrado.some(r => r.id === ultimoResultado.id);
      if (ya){
        if (!confirm("Ya existe un riesgo con ese ID. ¿Deseas reemplazarlo?")) return;
        concentrado = concentrado.filter(r => r.id !== ultimoResultado.id);
      }

      concentrado.push({ ...ultimoResultado });
      renderTabla();
      renderNiveles();
    }

    function nivelTag(nivel){
      if (nivel === "Bajo") return `<span class="tag" style="border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.06);">Bajo</span>`;
      if (nivel === "Medio") return `<span class="tag" style="border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.06);">Medio</span>`;
      if (nivel === "Alto") return `<span class="tag" style="border-color:rgba(220,38,38,.25); background:rgba(220,38,38,.06);">Alto</span>`;
      return `<span class="tag" style="border-color:rgba(124,58,237,.25); background:rgba(124,58,237,.06);">Crítico</span>`;
    }

    function renderTabla(){
      const tbody = document.getElementById("tbl_body");
      if (concentrado.length === 0){
        tbody.innerHTML = `<tr><td colspan="9" class="small">Aún no has agregado riesgos al concentrado.</td></tr>`;
        return;
      }

      const rows = [...concentrado].sort((a,b)=> b.residual - a.residual);

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.area || "—")}</td>
          <td>${escapeHtml(r.desc || "—")}</td>
          <td class="mono">${r.prob}</td>
          <td class="mono">${r.impacto}</td>
          <td class="mono">${r.residual.toFixed(2)}</td>
          <td>${nivelTag(r.nivel)}</td>
          <td>${escapeHtml(r.accion)}</td>
          <td class="mono">${escapeHtml((r.iso || []).join("; ") || "—")}</td>
        </tr>
      `).join("");
    }

    function limpiarConcentrado(){
      if (!confirm("¿Seguro que deseas borrar todo el concentrado?")) return;
      concentrado = [];
      renderTabla();
      renderNiveles();
    }

    // =========================
    // Exportar CSV y Excel .xls
    // =========================
    function exportarCSV(){
      if (concentrado.length === 0){
        alert("No hay datos para exportar.");
        return;
      }
      const headers = ["ID","Área","Descripción","Probabilidad","Impacto","Base","Ajustado","Residual","Nivel","Acción","ISO"];
      const lines = [headers.join(",")];

      concentrado.forEach(r=>{
        const row = [
          r.id,
          r.area || "",
          (r.desc || "").replaceAll("\n"," ").replaceAll("\r"," "),
          r.prob,
          r.impacto,
          r.base,
          r.ajustado,
          r.residual,
          r.nivel,
          r.accion,
          (r.iso || []).join(";")
        ].map(v => `"${String(v).replaceAll('"','""')}"`);
        lines.push(row.join(","));
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "concentrado_riesgos.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportarExcelXLS(){
      if (concentrado.length === 0){
        alert("No hay datos para exportar.");
        return;
      }

      const tabla = document.getElementById("tabla_concentrado").outerHTML;

      const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:x="urn:schemas-microsoft-com:office:excel"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8">
          <!--[if gte mso 9]><xml>
            <x:ExcelWorkbook>
              <x:ExcelWorksheets>
                <x:ExcelWorksheet>
                  <x:Name>Riesgos</x:Name>
                  <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
                </x:ExcelWorksheet>
              </x:ExcelWorksheets>
            </x:ExcelWorkbook>
          </xml><![endif]-->
          <style>
            table{border-collapse:collapse;}
            th,td{border:1px solid #ccc; padding:6px; font-family:Arial; font-size:12px;}
            th{background:#EAF2FB;}
          </style>
        </head>
        <body>
          <h3>Concentrado de riesgos</h3>
          ${tabla}
        </body></html>
      `;

      const blob = new Blob([html], {type:"application/vnd.ms-excel;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "concentrado_riesgos.xls";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =========================
    // Gráfica niveles
    // =========================
    function contarPorNivel(){
      const c = { Bajo:0, Medio:0, Alto:0, Crítico:0 };
      concentrado.forEach(r => {
        if (r.nivel === "Bajo") c.Bajo++;
        else if (r.nivel === "Medio") c.Medio++;
        else if (r.nivel === "Alto") c.Alto++;
        else c.Crítico++;
      });
      return c;
    }

    function renderNiveles(){
      const canvas = document.getElementById("chartNiveles");
      const ctx = canvas.getContext("2d");
      const counts = contarPorNivel();
      const styles = getComputedStyle(document.documentElement);

      const colors = {
        Bajo: styles.getPropertyValue("--good").trim(),
        Medio: styles.getPropertyValue("--warn").trim(),
        Alto: styles.getPropertyValue("--bad").trim(),
        Crítico: styles.getPropertyValue("--crit").trim(),
      };

      const labels = ["Bajo","Medio","Alto","Crítico"];
      const data = labels.map(l => counts[l]);

      ctx.clearRect(0,0,canvas.width,canvas.height);

      const padL = 40, padR = 16, padT = 18, padB = 34;
      const w = canvas.width - padL - padR;
      const h = canvas.height - padT - padB;

      const maxVal = Math.max(1, ...data);

      ctx.strokeStyle = "rgba(0,0,0,.15)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + h);
      ctx.lineTo(padL + w, padT + h);
      ctx.stroke();

      ctx.font = "12px Arial";
      const steps = Math.min(5, maxVal);
      for (let s=0; s<=steps; s++){
        const val = Math.round((maxVal/steps)*s);
        const y = padT + h - (h * (val/maxVal));
        ctx.strokeStyle = "rgba(0,0,0,.06)";
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + w, y);
        ctx.stroke();
        ctx.fillStyle = "rgba(0,0,0,.55)";
        ctx.fillText(String(val), 8, y+4);
      }

      const gap = 18;
      const barW = (w - gap*(labels.length-1)) / labels.length;

      labels.forEach((lab, idx)=>{
        const x = padL + idx*(barW+gap);
        const val = counts[lab];
        const barH = h * (val/maxVal);
        const y = padT + h - barH;

        ctx.fillStyle = colors[lab];
        ctx.fillRect(x, y, barW, barH);

        ctx.fillStyle = "rgba(0,0,0,.70)";
        ctx.fillText(String(val), x + (barW/2) - 3, y - 6);

        ctx.fillStyle = "rgba(0,0,0,.65)";
        ctx.fillText(lab, x + 6, padT + h + 22);
      });

      const total = concentrado.length;
      document.getElementById("statsNiveles").textContent =
        `Total: ${total} | Bajo: ${counts.Bajo} | Medio: ${counts.Medio} | Alto: ${counts.Alto} | Crítico: ${counts["Crítico"]}`;
    }

    // =========================
    // Heatmap 5x5
    // =========================
    function heatColor(base){
      const styles = getComputedStyle(document.documentElement);
      if (base <= 5)  return styles.getPropertyValue("--good").trim();
      if (base <= 10) return styles.getPropertyValue("--warn").trim();
      if (base <= 15) return styles.getPropertyValue("--bad").trim();
      return styles.getPropertyValue("--crit").trim();
    }

    function renderHeatmap(current){
      const canvas = document.getElementById("chartHeatmap");
      const ctx = canvas.getContext("2d");

      ctx.clearRect(0,0,canvas.width,canvas.height);

      const padL = 70, padR = 14, padT = 20, padB = 55;
      const w = canvas.width - padL - padR;
      const h = canvas.height - padT - padB;

      const cellW = w / 5;
      const cellH = h / 5;

      ctx.fillStyle = "rgba(0,0,0,.75)";
      ctx.font = "13px Arial";
      ctx.fillText("Impacto (1 → 5)", padL + 10, padT - 4);

      ctx.save();
      ctx.translate(18, padT + h/2);
      ctx.rotate(-Math.PI/2);
      ctx.font = "13px Arial";
      ctx.fillStyle = "rgba(0,0,0,.75)";
      ctx.fillText("Probabilidad (1 → 5)", 0, 0);
      ctx.restore();

      for (let p=1; p<=5; p++){
        for (let i=1; i<=5; i++){
          const base = p*i;
          const x = padL + (i-1)*cellW;
          const y = padT + (5-p)*cellH;

          ctx.fillStyle = heatColor(base);
          ctx.globalAlpha = 0.18;
          ctx.fillRect(x, y, cellW, cellH);
          ctx.globalAlpha = 1;

          ctx.strokeStyle = "rgba(0,0,0,.10)";
          ctx.strokeRect(x, y, cellW, cellH);

          ctx.fillStyle = "rgba(0,0,0,.55)";
          ctx.font = "12px Arial";
          ctx.fillText(String(base), x + 6, y + 16);
        }
      }

      ctx.fillStyle = "rgba(0,0,0,.60)";
      ctx.font = "12px Arial";
      for (let i=1; i<=5; i++){
        const x = padL + (i-1)*cellW + cellW/2 - 3;
        ctx.fillText(String(i), x, padT + h + 22);
      }
      for (let p=1; p<=5; p++){
        const y = padT + (5-p)*cellH + cellH/2 + 4;
        ctx.fillText(String(p), padL - 18, y);
      }

      if (current && current.prob && current.impacto){
        const p = current.prob;
        const i = current.impacto;
        const x = padL + (i-1)*cellW + cellW/2;
        const y = padT + (5-p)*cellH + cellH/2;

        ctx.beginPath();
        ctx.arc(x, y, Math.min(cellW, cellH)*0.20, 0, Math.PI*2);
        ctx.fillStyle = "rgba(0,0,0,.75)";
        ctx.fill();

        ctx.beginPath();
        ctx.arc(x, y, Math.min(cellW, cellH)*0.28, 0, Math.PI*2);
        ctx.strokeStyle = "rgba(255,255,255,.95)";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = "rgba(0,0,0,.75)";
        ctx.font = "12px Arial";
        const label = `ID: ${current.id} (P${p}×I${i})`;
        ctx.fillText(label, padL, canvas.height - 18);
      } else {
        ctx.fillStyle = "rgba(0,0,0,.55)";
        ctx.font = "12px Arial";
        ctx.fillText("Calcula un riesgo para marcar su posición.", padL, canvas.height - 18);
      }
    }

    // =========================
    // Limpieza
    // =========================
    function limpiarResultados(){
      document.getElementById("prob_det").textContent = "";
      document.getElementById("impacto_det").textContent = "";
      document.getElementById("score_base").textContent = "—";
      document.getElementById("score_ajustado").textContent = "—";
      document.getElementById("score_residual").textContent = "—";
      document.getElementById("mod_cia").textContent = "—";
      document.getElementById("mod_activo").textContent = "—";
      document.getElementById("mod_controles").textContent = "—";
      document.getElementById("nivel").textContent = "Clasificación: —";
      document.getElementById("accion_prior").textContent = "—";
      document.getElementById("pct").textContent = "0%";
      document.getElementById("fill").style.width = "0%";
      document.getElementById("out_detalle").textContent = "—";
      document.getElementById("recs").innerHTML = "";
      document.getElementById("estado").textContent = "Sin calcular";
      setDotColor("none");
      ultimoResultado = null;
      renderHeatmap(null);
    }

    function limpiarFormulario(){
      document.getElementById("risk_id").value = "";
      document.getElementById("area").value = "";
      document.getElementById("desc").value = "";

      document.getElementById("prob").value = 3;
      document.getElementById("impacto").value = 3;

      document.getElementById("cia_conf").value = "Alto";
      document.getElementById("cia_int").value = "Alto";
      document.getElementById("cia_disp").value = "Alto";

      document.getElementById("valor_activo").value = "Crítico/Esencial para la Misión";
      document.getElementById("controles").value = "No Especificado";

      document.getElementById("iso_search").value = "";
      renderCatalogoISO("");
      document.getElementById("iso_manual").value = "";
      limpiarControlesISO();

      limpiarResultados();
    }

    // =========================
    // INIT
    // =========================
    fillSelectByN("prob", PROBABILIDAD);
    fillSelectByN("impacto", IMPACTO);
    fillSelectByKey("cia_conf", CIA, "Alto");
    fillSelectByKey("cia_int", CIA, "Alto");
    fillSelectByKey("cia_disp", CIA, "Alto");
    fillSelectByKey("valor_activo", VALOR_ACTIVO, "Crítico/Esencial para la Misión");
    fillSelectByKey("controles", CONTROLES_EXISTENTES, "No Especificado");

    document.getElementById("prob").addEventListener("change", ()=> {
      const pObj = getByN(PROBABILIDAD, Number(document.getElementById("prob").value));
      document.getElementById("prob_det").textContent = pObj?.detalle || "";
    });
    document.getElementById("impacto").addEventListener("change", ()=> {
      const iObj = getByN(IMPACTO, Number(document.getElementById("impacto").value));
      document.getElementById("impacto_det").textContent = iObj?.detalle || "";
    });

    document.getElementById("iso_search").addEventListener("input", (e)=>{
      renderCatalogoISO(e.target.value);
    });

    renderCatalogoISO("");
    renderISOChips();

    renderTabla();
    renderNiveles();
    renderHeatmap(null);
    limpiarResultados();
  </script>
</body>
</html>
