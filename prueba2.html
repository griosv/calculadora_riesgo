<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Riesgo</title>

  <style>
    :root{
      /* Paleta inspirada en CONTPAQi */
      --brand:#005EB8;
      --brand-dark:#004A92;
      --ink:#263031;
      --muted:#7C878E;

      /* UI */
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#263031;
      --border:rgba(0,0,0,.10);

      /* Estados */
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --crit:#7c3aed;
    }

    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{margin:0; min-height:100vh; color:var(--text); background:var(--bg); padding:22px;}
    .wrap{max-width:1200px; margin:0 auto;}

    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:14px;
      margin-bottom:14px;
    }
    h1{margin:0; font-size:28px; color:var(--brand); letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(0,94,184,.25);
      border-radius:999px;
      padding:8px 12px;
      background: rgba(0,94,184,.06);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:#94a3b8;}
    .pill strong{font-size:13px;}

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }

    .section-title{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
      margin-bottom:10px;
    }
    .section-title h2{margin:0; font-size:16px; color:var(--ink);}
    .hint{color:var(--muted); font-size:12px; line-height:1.35;}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:12px;}
    label{display:block; color:var(--ink); font-size:12px; margin-bottom:6px;}

    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:86px; resize:vertical;}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(0,94,184,.65);
      box-shadow: 0 0 0 3px rgba(0,94,184,.15);
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      cursor:pointer;
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
    }
    button.primary{
      background: linear-gradient(90deg, rgba(0,94,184,.20), rgba(0,94,184,.08));
      border-color: rgba(0,94,184,.35);
      color: var(--ink);
    }
    button.primary:hover{
      background: linear-gradient(90deg, rgba(0,94,184,.30), rgba(0,94,184,.12));
      border-color: rgba(0,94,184,.45);
    }
    button.ghost{background:#fff;}
    button.muted{background:#f3f4f6;}

    .divider{height:1px; background:rgba(0,0,0,.08); margin:14px 0;}
    .small{font-size:12px; color:var(--muted); line-height:1.35;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .box .t{color:var(--muted); font-size:12px;}
    .box .v{margin-top:4px; font-size:22px; font-weight:900; color:var(--ink);}
    .box .s{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35;}

    .bar{height:12px; border-radius:999px; background:rgba(0,0,0,.08); overflow:hidden; border:1px solid var(--border);}
    .bar > div{height:100%; width:0%; background:var(--brand);}

    ul{margin:8px 0 0 18px; padding:0;}
    li{color:var(--muted); margin:6px 0; font-size:12px; line-height:1.35;}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Calculadora de Riesgo</h1>
        <div class="sub">
          Modelo: <span class="mono">Base = P×I</span> ·
          <span class="mono">Ajustado = Base×(1+CIA%)×Activo</span> ·
          <span class="mono">Residual = Ajustado×FactorControles</span>
        </div>
      </div>
      <div class="pill">
        <span class="dot" id="dot"></span>
        <strong id="estado">Sin calcular</strong>
      </div>
    </header>

    <div class="grid">

      <!-- Entradas -->
      <div class="card">
        <div class="section-title">
          <h2>Entradas</h2>
          <div class="hint">Selecciona criterios y presiona <b>Calcular</b>.</div>
        </div>

        <div class="row">
          <div>
            <label>Probabilidad</label>
            <select id="prob"></select>
            <div class="small" id="prob_det"></div>
          </div>
          <div>
            <label>Impacto</label>
            <select id="impacto"></select>
            <div class="small" id="impacto_det"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Modificador CIA</h2>
          <div class="hint">Suma porcentajes. Ejemplo: Alto+Alto+Alto = <b>+90%</b>.</div>
        </div>

        <div class="row3">
          <div>
            <label>Confidencialidad</label>
            <select id="cia_conf"></select>
          </div>
          <div>
            <label>Integridad</label>
            <select id="cia_int"></select>
          </div>
          <div>
            <label>Disponibilidad</label>
            <select id="cia_disp"></select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Valor del activo</label>
            <select id="valor_activo"></select>
            <div class="small">Aumenta el riesgo según criticidad del activo.</div>
          </div>
          <div>
            <label>Controles existentes</label>
            <select id="controles"></select>
            <div class="small">Reduce el riesgo según madurez/fortaleza de controles.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ID / Folio (opcional)</label>
            <input id="folio" placeholder="Ej. R-2026-001" />
          </div>
          <div>
            <label>Área / Proceso (opcional)</label>
            <input id="area" placeholder="Ej. TI / Desarrollo" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>Descripción (opcional)</label>
          <textarea id="desc" placeholder="Describe el riesgo, causa, consecuencia, etc."></textarea>
        </div>

        <!-- Controles ISO -->
        <div class="divider"></div>

        <div class="section-title">
          <h2>Controles ISO/IEC 27001:2022</h2>
          <div class="hint">Selecciona controles relacionados. Puedes cargar tu lista completa pegando JSON.</div>
        </div>

        <div class="row">
          <div>
            <label>Buscar control</label>
            <input id="ctrl_buscar" placeholder="Ej. 8.8 o 'vulnerabilidad' o 'acceso'..." />
            <div class="small">Tip: escribe “5.”, “6.”, “7.” u “8.” para filtrar por sección.</div>
          </div>
          <div>
            <label>Agregar control</label>
            <select id="ctrl_select"></select>
            <div class="btns" style="margin-top:10px;">
              <button class="primary" type="button" onclick="agregarControl()">Agregar</button>
              <button class="muted" type="button" onclick="limpiarControles()">Limpiar controles</button>
            </div>
          </div>
        </div>

        <div class="box" style="margin-top:10px;">
          <div class="t">Controles seleccionados</div>
          <div class="s" id="ctrl_lista">—</div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Cargar lista de controles (opcional)</h2>
          <div class="hint">Pega tu JSON. Formato: [{ "id":"8.8", "nombre":"..." }, ...]</div>
        </div>

        <textarea id="ctrl_json" placeholder='Ejemplo:
[
  {"id":"8.8","nombre":"Gestión de vulnerabilidades"},
  {"id":"8.15","nombre":"Registro (logging)"},
  {"id":"8.13","nombre":"Respaldos"}
]'></textarea>

        <div class="btns">
          <button type="button" onclick="cargarControlesDesdeJSON()">Cargar controles desde JSON</button>
        </div>

        <div class="divider"></div>

        <div class="btns">
          <button class="primary" onclick="calcular()">Calcular</button>
          <button class="ghost" onclick="limpiar()">Limpiar</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          Si quieres que la clasificación (Bajo/Medio/Alto/Crítico) coincida 1:1 con tu referencia,
          ajusto los rangos en el código en 1 minuto.
        </div>
      </div>

      <!-- Resultados -->
      <div class="card">
        <div class="section-title">
          <h2>Resultados</h2>
          <div class="hint">Resultados numéricos, clasificación y recomendaciones.</div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="t">Riesgo base (P×I)</div>
            <div class="v" id="score_base">—</div>
            <div class="s">Rango: 1 a 25</div>
          </div>
          <div class="box">
            <div class="t">Riesgo ajustado</div>
            <div class="v" id="score_ajustado">—</div>
            <div class="s">Incluye CIA y activo</div>
          </div>
        </div>

        <div class="box" style="margin-top:10px;">
          <div class="t">Modificadores</div>
          <div class="s">
            CIA: <b id="mod_cia">—</b> &nbsp;|&nbsp;
            Activo: <b id="mod_activo">—</b> &nbsp;|&nbsp;
            Controles: <b id="mod_controles">—</b>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box">
            <div class="t">Riesgo residual</div>
            <div class="v" id="score_residual">—</div>
            <div class="s" id="nivel">Clasificación: —</div>
          </div>
          <div class="box">
            <div class="t">Acción prioritaria</div>
            <div class="v" style="font-size:14px; font-weight:900;" id="accion_prior">—</div>
            <div class="s">Definida con base en el residual</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="small" style="display:flex;justify-content:space-between;margin-bottom:6px;">
            <span>Indicador visual</span>
            <span id="pct">0%</span>
          </div>
          <div class="bar"><div id="fill"></div></div>
          <div class="hint" id="out_detalle" style="margin-top:10px;">—</div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Recomendaciones</h2>
          <div class="hint">Sugerencias generales (ajustables a tu SGSI/política).</div>
        </div>
        <ul id="recs"></ul>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Controles ISO seleccionados</h2>
          <div class="hint">Se reflejan los controles que marcaste en la parte izquierda.</div>
        </div>
        <div class="box">
          <div class="t">Lista</div>
          <div class="s" id="ctrl_lista_res">—</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // =========================
    // Datos de criterios (ES)
    // =========================
    const PROBABILIDAD = [
      { n: 1, label: "1 - Raro (<1% anual)", detalle: "Muy poco probable. Frecuencia esperada: >5 años." },
      { n: 2, label: "2 - Improbable (1–10% anual)", detalle: "Poco probable. Frecuencia esperada: 2–5 años." },
      { n: 3, label: "3 - Posible (10–50% anual)", detalle: "Podría ocurrir. Frecuencia esperada: 1–5 años." },
      { n: 4, label: "4 - Probable (50–90% anual)", detalle: "Probable. Frecuencia esperada: 6–12 meses." },
      { n: 5, label: "5 - Casi seguro (>90% anual)", detalle: "Altamente probable. Frecuencia esperada: <6 meses." },
    ];

    const IMPACTO = [
      { n: 1, label: "1 - Insignificante (<$10K pérdida)", detalle: "Impacto menor. Manejo local." },
      { n: 2, label: "2 - Menor ($10K–$100K pérdida)", detalle: "Impacto bajo/moderado." },
      { n: 3, label: "3 - Moderado ($100K–$1M pérdida)", detalle: "Impacto significativo. Requiere gestión." },
      { n: 4, label: "4 - Mayor ($1M–$10M pérdida)", detalle: "Impacto alto. Afecta objetivos críticos." },
      { n: 5, label: "5 - Catastrófico (>$10M pérdida)", detalle: "Impacto extremo. Afecta continuidad." },
    ];

    // Para replicar el ejemplo +90% con Alto/Alto/Alto:
    // Ninguno=0%, Bajo=10%, Medio=20%, Alto=30%
    const CIA = [
      { key: "Ninguno", label: "Ninguno", pct: 0.00 },
      { key: "Bajo",    label: "Bajo",    pct: 0.10 },
      { key: "Medio",   label: "Medio",   pct: 0.20 },
      { key: "Alto",    label: "Alto",    pct: 0.30 },
    ];

    const VALOR_ACTIVO = [
      { key: "No especificado", label: "No especificado", mult: 1.0 },
      { key: "Valor Bajo", label: "Valor Bajo", mult: 1.0 },
      { key: "Valor Medio", label: "Valor Medio", mult: 1.2 },
      { key: "Valor Alto", label: "Valor Alto", mult: 1.3 },
      { key: "Crítico/Esencial para la Misión", label: "Crítico/Esencial para la Misión", mult: 1.5 },
    ];

    const CONTROLES_EXISTENTES = [
      { key: "No Especificado", label: "No especificado", factor: 1.0 },
      { key: "Ninguno Implementado", label: "Ninguno implementado", factor: 1.0 },
      { key: "Débil/Parcial", label: "Débil / Parcial", factor: 0.8 },
      { key: "Moderado", label: "Moderado", factor: 0.6 },
      { key: "Fuerte/Integral", label: "Fuerte / Integral", factor: 0.4 },
    ];

    // ======================================
    // Controles ISO 27001:2022 (ejemplos)
    // ======================================
    // Nota: ISO tiene derechos de autor; aquí incluyo ejemplos, y puedes cargar tu lista completa con JSON.
    let CONTROLES_ISO = [
      { id: "5.1",  nombre: "Políticas de seguridad de la información" },
      { id: "5.7",  nombre: "Inteligencia de amenazas" },
      { id: "5.15", nombre: "Control de acceso (política)" },
      { id: "5.23", nombre: "Seguridad de la información para uso de servicios en la nube" },
      { id: "6.3",  nombre: "Concientización, educación y capacitación" },
      { id: "7.4",  nombre: "Monitoreo de seguridad física" },
      { id: "8.8",  nombre: "Gestión de vulnerabilidades" },
      { id: "8.9",  nombre: "Gestión de configuración" },
      { id: "8.13", nombre: "Respaldos (backups)" },
      { id: "8.15", nombre: "Registro (logging)" },
    ];

    let controlesSeleccionados = [];

    // =========================
    // Helpers UI
    // =========================
    function fillSelectByN(selId, arr){
      const sel = document.getElementById(selId);
      sel.innerHTML = "";
      arr.forEach(o=>{
        const op = document.createElement("option");
        op.value = o.n;
        op.textContent = o.label;
        sel.appendChild(op);
      });
      sel.value = arr[2]?.n ?? arr[0]?.n ?? 1;
    }

    function fillSelectByKey(selId, arr, defaultKey){
      const sel = document.getElementById(selId);
      sel.innerHTML = "";
      arr.forEach(o=>{
        const op = document.createElement("option");
        op.value = o.key;
        op.textContent = o.label;
        sel.appendChild(op);
      });
      sel.value = defaultKey ?? arr[0]?.key ?? "";
    }

    function getByN(arr, n){ return arr.find(x => x.n === n); }
    function getByKey(arr, k){ return arr.find(x => x.key === k); }

    function setDotColor(kind){
      const dot = document.getElementById("dot");
      const fill = document.getElementById("fill");
      let color = "#94a3b8";
      if (kind === "good") color = getComputedStyle(document.documentElement).getPropertyValue("--good").trim();
      if (kind === "warn") color = getComputedStyle(document.documentElement).getPropertyValue("--warn").trim();
      if (kind === "bad")  color = getComputedStyle(document.documentElement).getPropertyValue("--bad").trim();
      if (kind === "crit") color = getComputedStyle(document.documentElement).getPropertyValue("--crit").trim();
      dot.style.background = color;
      fill.style.background = color;
    }

    // =========================
    // Controles ISO (UI)
    // =========================
    function renderSelectControles(filtro = "") {
      const sel = document.getElementById("ctrl_select");
      const q = (filtro || "").toLowerCase().trim();

      const items = CONTROLES_ISO
        .filter(c => {
          if (!q) return true;
          return (c.id.toLowerCase().includes(q) || c.nombre.toLowerCase().includes(q));
        })
        .slice(0, 250);

      sel.innerHTML = "";
      if (items.length === 0) {
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "Sin resultados (carga tu lista en JSON o cambia el filtro)";
        sel.appendChild(op);
        return;
      }

      items.forEach(c => {
        const op = document.createElement("option");
        op.value = c.id;
        op.textContent = `${c.id} — ${c.nombre}`;
        sel.appendChild(op);
      });
    }

    function agregarControl() {
      const sel = document.getElementById("ctrl_select");
      const id = sel.value;
      if (!id) return;

      const c = CONTROLES_ISO.find(x => x.id === id);
      if (!c) return;

      if (!controlesSeleccionados.some(x => x.id === c.id)) {
        controlesSeleccionados.push(c);
        renderListaControles();
      }
    }

    function limpiarControles() {
      controlesSeleccionados = [];
      renderListaControles();
    }

    function renderListaControles() {
      const el1 = document.getElementById("ctrl_lista");
      const el2 = document.getElementById("ctrl_lista_res");

      if (controlesSeleccionados.length === 0) {
        el1.textContent = "—";
        el2.textContent = "—";
        return;
      }

      const html = controlesSeleccionados
        .map(c => `<span class="mono">${c.id}</span> — ${c.nombre}`)
        .join("<br/>");

      el1.innerHTML = html;
      el2.innerHTML = html;
    }

    function cargarControlesDesdeJSON() {
      const txt = document.getElementById("ctrl_json").value.trim();
      if (!txt) return;

      try {
        const arr = JSON.parse(txt);
        if (!Array.isArray(arr)) throw new Error("El JSON debe ser un arreglo.");

        const normalizados = arr
          .filter(x => x && typeof x.id === "string" && typeof x.nombre === "string")
          .map(x => ({ id: x.id.trim(), nombre: x.nombre.trim() }))
          .filter(x => x.id && x.nombre);

        if (normalizados.length === 0) throw new Error("No encontré objetos válidos con {id, nombre}.");

        CONTROLES_ISO = normalizados;
        renderSelectControles(document.getElementById("ctrl_buscar").value);
        alert("Lista de controles cargada correctamente.");
      } catch (e) {
        alert("Error al cargar JSON: " + e.message);
      }
    }

    // =========================
    // Clasificación + recomendaciones (ES)
    // =========================
    function clasificar(scoreResidual){
      // Umbrales sugeridos (ajustables a tu apetito/política)
      if (scoreResidual <= 10) return {
        nivel:"Bajo",
        accion:"Aceptar / Revisar periódicamente",
        sem:"good",
        rec:[
          "Aceptar el riesgo y documentarlo en el registro de riesgos.",
          "Definir revisión periódica (por ejemplo trimestral).",
          "Mantener evidencias mínimas de monitoreo."
        ]
      };

      if (scoreResidual <= 25) return {
        nivel:"Medio",
        accion:"Monitorear / Revisar",
        sem:"warn",
        rec:[
          "Documentar el riesgo y asignar responsable.",
          "Definir mejoras de bajo esfuerzo (quick wins) a controles.",
          "Monitorear indicadores y revisar en comité o seguimiento mensual."
        ]
      };

      if (scoreResidual <= 50) return {
        nivel:"Alto",
        accion:"Mitigar (prioritario)",
        sem:"bad",
        rec:[
          "Definir plan de tratamiento con acciones, responsables y fechas.",
          "Fortalecer controles de acceso (MFA, privilegios mínimos, segregación).",
          "Implementar cifrado y monitoreo (logging, alertas, SIEM si aplica).",
          "Mejorar continuidad (respaldos, pruebas de restauración, DR)."
        ]
      };

      return {
        nivel:"Crítico",
        accion:"Acción inmediata (escalar)",
        sem:"crit",
        rec:[
          "Escalar de inmediato a la dirección/gerencia y al responsable del SGSI.",
          "Aplicar controles compensatorios urgentes para reducir exposición.",
          "Considerar detener/evitar la actividad hasta tratar el riesgo.",
          "Abrir incidente/problema y seguimiento diario hasta estabilizar."
        ]
      };
    }

    // =========================
    // Cálculo principal
    // =========================
    function calcular(){
      const p = Number(document.getElementById("prob").value);
      const i = Number(document.getElementById("impacto").value);

      const ciaC = getByKey(CIA, document.getElementById("cia_conf").value);
      const ciaI = getByKey(CIA, document.getElementById("cia_int").value);
      const ciaD = getByKey(CIA, document.getElementById("cia_disp").value);

      const activo = getByKey(VALOR_ACTIVO, document.getElementById("valor_activo").value);
      const ctrl = getByKey(CONTROLES_EXISTENTES, document.getElementById("controles").value);

      const base = p * i; // 1..25
      const ciaPct = (ciaC?.pct || 0) + (ciaI?.pct || 0) + (ciaD?.pct || 0);
      const multActivo = activo?.mult || 1.0;
      const factorCtrl = ctrl?.factor ?? 1.0;

      const ajustado = base * (1 + ciaPct) * multActivo;
      const residual = ajustado * factorCtrl;

      // Detalles
      const pObj = getByN(PROBABILIDAD, p);
      const iObj = getByN(IMPACTO, i);
      document.getElementById("prob_det").textContent = pObj?.detalle || "";
      document.getElementById("impacto_det").textContent = iObj?.detalle || "";

      // Scores
      document.getElementById("score_base").textContent = base.toFixed(2);
      document.getElementById("score_ajustado").textContent = ajustado.toFixed(2);
      document.getElementById("score_residual").textContent = residual.toFixed(2);

      // Modificadores
      document.getElementById("mod_cia").textContent = `+${Math.round(ciaPct*100)}%`;
      document.getElementById("mod_activo").textContent = `${multActivo.toFixed(1)}x`;
      document.getElementById("mod_controles").textContent = `${factorCtrl.toFixed(1)}`;

      // Clasificación y recomendaciones
      const c = clasificar(residual);
      document.getElementById("nivel").textContent = `Clasificación: ${c.nivel}`;
      document.getElementById("accion_prior").textContent = c.accion;
      document.getElementById("estado").textContent = c.accion;
      setDotColor(c.sem);

      const ul = document.getElementById("recs");
      ul.innerHTML = "";
      c.rec.forEach(t=>{
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });

      // Indicador visual (normalización)
      // Ajusta 'max' si quieres un % más/menos sensible
      const max = 75;
      const pct = Math.max(0, Math.min(100, Math.round((residual / max) * 100)));
      document.getElementById("pct").textContent = pct + "%";
      document.getElementById("fill").style.width = pct + "%";

      const folio = document.getElementById("folio").value || "—";
      const area = document.getElementById("area").value || "—";
      const controlesISO = controlesSeleccionados.map(x => x.id).join(", ") || "—";

      document.getElementById("out_detalle").textContent =
        `Folio: ${folio} | Área: ${area} | Base: ${p}×${i}=${base.toFixed(2)} | CIA: +${Math.round(ciaPct*100)}% | Activo: ${multActivo.toFixed(1)}x | Controles: ${factorCtrl.toFixed(1)} | Residual: ${residual.toFixed(2)} | ISO: ${controlesISO}`;
    }

    function limpiar(){
      document.getElementById("folio").value = "";
      document.getElementById("area").value = "";
      document.getElementById("desc").value = "";
      document.getElementById("ctrl_buscar").value = "";
      document.getElementById("ctrl_json").value = "";

      // Defaults “tipo demo”
      document.getElementById("prob").value = 3;
      document.getElementById("impacto").value = 3;
      document.getElementById("cia_conf").value = "Alto";
      document.getElementById("cia_int").value = "Alto";
      document.getElementById("cia_disp").value = "Alto";
      document.getElementById("valor_activo").value = "Crítico/Esencial para la Misión";
      document.getElementById("controles").value = "No Especificado";

      // Limpieza de resultados
      document.getElementById("prob_det").textContent = "";
      document.getElementById("impacto_det").textContent = "";
      document.getElementById("score_base").textContent = "—";
      document.getElementById("score_ajustado").textContent = "—";
      document.getElementById("score_residual").textContent = "—";
      document.getElementById("mod_cia").textContent = "—";
      document.getElementById("mod_activo").textContent = "—";
      document.getElementById("mod_controles").textContent = "—";
      document.getElementById("nivel").textContent = "Clasificación: —";
      document.getElementById("accion_prior").textContent = "—";
      document.getElementById("pct").textContent = "0%";
      document.getElementById("fill").style.width = "0%";
      document.getElementById("out_detalle").textContent = "—";
      document.getElementById("recs").innerHTML = "";
      document.getElementById("estado").textContent = "Sin calcular";
      setDotColor("none");

      // Controles ISO seleccionados
      limpiarControles();
      renderSelectControles("");
    }

    // =========================
    // Inicialización
    // =========================
    fillSelectByN("prob", PROBABILIDAD);
    fillSelectByN("impacto", IMPACTO);
    fillSelectByKey("cia_conf", CIA, "Alto");
    fillSelectByKey("cia_int", CIA, "Alto");
    fillSelectByKey("cia_disp", CIA, "Alto");
    fillSelectByKey("valor_activo", VALOR_ACTIVO, "Crítico/Esencial para la Misión");
    fillSelectByKey("controles", CONTROLES_EXISTENTES, "No Especificado");

    document.getElementById("prob").addEventListener("change", ()=> {
      const pObj = getByN(PROBABILIDAD, Number(document.getElementById("prob").value));
      document.getElementById("prob_det").textContent = pObj?.detalle || "";
    });
    document.getElementById("impacto").addEventListener("change", ()=> {
      const iObj = getByN(IMPACTO, Number(document.getElementById("impacto").value));
      document.getElementById("impacto_det").textContent = iObj?.detalle || "";
    });

    document.getElementById("ctrl_buscar").addEventListener("input", (e)=> {
      renderSelectControles(e.target.value);
    });

    // Render controles ISO
    renderSelectControles("");
    renderListaControles();

    // defaults
    limpiar();
  </script>
</body>
</html>
